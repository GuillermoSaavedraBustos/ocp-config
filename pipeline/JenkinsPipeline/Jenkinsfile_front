node('phantomjs') {
   
   npmPath="${env.JENKINS_URL}/node-v6.10.3-linux-x64/bin"
   
   stage('Prepare node') {
     sh "curl -O https://nodejs.org/download/release/v6.10.3/node-v6.10.3-linux-x64.tar.gz"
     sh "tar xzf node-v6.10.3-linux-x64.tar.gz"
     sh "chmod u+x ${npmPath}/node"
   }
  
  stage('Checkout Source') {
    echo "Checkout Source"
    dir('ose-wallapp-ui-test') {
      git 'https://github.com/hsavolai/ose-wallapp-ui.git'
    }
    dir('ose-wallapp-router-test') {
      git 'https://github.com/hsavolai/ose-router-ui.git'
    }
    
    withEnv(["PATH+NODE=${npmPath}"]) {
      sh "npm config set registry http://nexus3:8081/repository/npm-all/"  
      sh "npm config set progress=false"
    }
    sh "cp -r ./ose-wallapp-router-test ose-wallapp-router-prod"
    sh "cp -r ./ose-wallapp-ui-test ose-wallapp-ui-prod"
  }

  def packageVersion = null

  def buildNumber = sh (
    script: "cd ose-wallapp-router-test; git rev-list --all --count; cd ..",
    returnStdout: true
  ).trim()

  def unixTime = sh (
    script: 'date +"%s"',
    returnStdout: true
   ).trim()

  stage('Resolve test deps') {
    withEnv(["PATH+NODE=${npmPath}"]) {
      sh "npm install --prefix ./ose-wallapp-ui-test"
      sh "npm install --prefix ./ose-wallapp-router-test"
    }
  }

  stage('Test & Analysis') {
    withEnv(["PATH+NODE=${npmPath}"]) {
      sh "npm run test-headless --prefix ./ose-wallapp-ui-test"
      sh "npm test --prefix ./ose-wallapp-router-test"
    }
  }
  
  stage('Define version') {
    def version = getVersionFromPackageJs("./ose-wallapp-router-prod/package.json")
    packageVersion = "${version}-${buildNumber}_${unixTime}"
    echo "The final package version is ${packageVersion}"
  }
  
  stage('Build and package') {
    echo "Build production package"
    withEnv(["PATH+NODE=${npmPath}"]) {
     sh "npm install --prefix ./ose-wallapp-router-prod --production"
     sh "cd ./ose-wallapp-ui-prod;node ./node_modules/@angular/cli/bin/ng build --progress false --base-href /wall/ --output-path ../ose-wallapp-router-prod/public/wall -prod;cd .."
    }
    echo "Prepare production package"
    sh "rm -rf ./ose-wallapp-router-prod/test"
    sh "rm -rf ./ose-wallapp-router-prod/LICENSE"
    sh "rm -rf ./ose-wallapp-router-prod/README.md"
    sh "rm -rf ./ose-wallapp-router-prod/.git"
    
    sh "tar -C ./ose-wallapp-router-prod -czf tmp-ose-wall-router-ui-${packageVersion}.tar.gz ."
  }
  
  stage('Publish to Nexus') {
     echo "Publish to Nexus"
     sh "curl -v -u admin:admin123 --upload-file tmp-ose-wall-router-ui-${packageVersion}.tar.gz http://nexus3:8081/repository/maven-releases/org/savolainen/ose-wall-router-ui/${packageVersion}/ose-wall-router-ui-${packageVersion}.tar.gz"  
   }

  stage('Build OpenShift Image') {
    sh "oc project my-dev-project"
    def GET_BUILD_OUTPUT = sh (
       script: "oc get all -l build=ose-wall-router-ui -n my-dev-project 2>&1",
      returnStdout: true
    ).trim()
  
    echo "Get build output: ${GET_BUILD_OUTPUT}"
    
    if (GET_BUILD_OUTPUT.contains("No resources found.")){
      sh "oc new-build --binary=true --name=ose-wall-router-ui -i=nodejs -n my-dev-project"
    }
    sh "curl -O http://nexus3:8081/repository/maven-releases/org/savolainen/ose-wall-router-ui/${packageVersion}/ose-wall-router-ui-${packageVersion}.tar.gz"
    sh "oc start-build ose-wall-router-ui --from-archive=./ose-wall-router-ui-${packageVersion}.tar.gz -n my-dev-project"
    openshiftVerifyBuild bldCfg: 'ose-wall-router-ui', checkForTriggeredDeployments: 'false', namespace: 'my-dev-project', verbose: 'false', waitTime: '300000'
    sh "oc tag my-dev-project/ose-wall-router-ui:latest my-dev-project/ose-wall-router-ui:${packageVersion} -n my-dev-project"
   }

   stage ('Deploy DEV') {
    sh "oc project my-dev-project"

    def GET_DC_OUTPUT = sh (
       script: "oc get dc/ose-wall-router-ui -n my-dev-project 2>&1",
       returnStatus: true
     ) == 0

    if (!GET_DC_OUTPUT){
      sh "oc new-app my-dev-project/ose-wall-router-ui:${packageVersion} -n my-dev-project -e WALL_SERVICE_BASEURL='http://ose-wall-service'"
      openshiftVerifyService apiURL: '', namespace: 'my-dev-project', svcName: 'ose-wall-router-ui', verbose: 'false' 
      sh "oc expose svc/ose-wall-router-ui --port=8080 -n my-dev-project"
      sh "oc set probe dc/ose-wall-router-ui --readiness --get-url=http://:8080/sanity --failure-threshold 3 --initial-delay-seconds 10 -n my-dev-project"
      sh "oc set probe dc/ose-wall-router-ui --liveness --get-url=http://:8080/sanity --failure-threshold 3 --initial-delay-seconds 10 -n my-dev-project"
    } else {

     sh "oc patch dc ose-wall-router-ui -n 'my-dev-project' -p '{\"spec\": {\"triggers\": [ { \"type\": \"ImageChange\", \"imageChangeParams\": { \"containerNames\": [ \"ose-wall-router-ui\" ], \"from\": { \"kind\": \"ImageStreamTag\", \"namespace\": \"my-dev-project\", \"name\": \"ose-wall-router-ui:${packageVersion}\"}}}]}}'"
     openshiftDeploy apiURL: '', authToken: '', depCfg: 'ose-wall-router-ui', namespace: 'my-dev-project', verbose: 'false', waitTime: '', waitUnit: 'sec'

    }  
    openshiftVerifyDeployment depCfg: 'ose-wall-router-ui', namespace: 'my-dev-project', replicaCount: '1', verbose: 'false', verifyReplicaCount: 'true', waitTime: '', waitUnit: 'sec'
  
   }
   
   stage('Integration Test') {
    applicationHostName = sh (
      script: "oc get route ose-wall-router-ui -o template --template '{{ .spec.host }}' -n my-dev-project",
      returnStdout: true
    )
    GET_HTTP_RESPCODE = sh (
       script: "curl -s -o /dev/null -w '%{http_code}' http://${applicationHostName}/sanity",
       returnStdout: true
    ) == "200"
  
    sh "oc tag my-dev-project/ose-wall-router-ui:${packageVersion} my-prod-project/ose-wall-router-ui:prod-${packageVersion} -n my-dev-project"
   }


}

      
 
// Convenience Functions to read variables from the pom.xml
def getVersionFromPackageJs(packagejs) {
  def matcher = readFile(packagejs) =~ '"version": "(.+)",'
  matcher ? matcher[0][1] : null
}


